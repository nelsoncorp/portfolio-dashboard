<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Portfolio Performance — NelsonCorp Wealth Management</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --green:#2d6a4f;--green-dark:#1b4332;--green-mid:#40916c;--green-light:#d8f3dc;
    --green-xlight:#f0faf2;--gold:#c9a84c;--gold-light:#f0d080;--white:#ffffff;
    --off-white:#f8f9f7;--light-gray:#eef0eb;--mid-gray:#c4cbbf;--border:#dde5d8;
    --text-dark:#1b2e1f;--text-mid:#3d5240;--text-light:#7a917e;--pos:#1a6b3c;--neg:#b83232;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{font-family:'Source Sans 3',sans-serif;font-size:16px;background:var(--off-white);color:var(--text-dark);min-height:100vh}
  .site-header{background:var(--green-dark);padding:0 44px;display:flex;align-items:center;justify-content:space-between;height:78px;border-bottom:4px solid var(--gold);flex-wrap:wrap;gap:10px}
  .logo-area{display:flex;align-items:center;gap:16px}
  .logo-img{height:46px;object-fit:contain;filter:brightness(0) invert(1)}
  .logo-divider{width:1px;height:34px;background:rgba(255,255,255,0.2)}
  .logo-sub{font-size:0.85rem;color:rgba(255,255,255,0.55);letter-spacing:0.1em;text-transform:uppercase}
  .header-date{font-size:0.88rem;color:rgba(255,255,255,0.5)}
  .title-bar{background:var(--green);padding:20px 44px;display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px}
  .title-bar h1{font-family:'Merriweather',serif;font-size:1.45rem;font-weight:400;color:#fff}
  .title-bar h1 span{color:var(--gold-light)}
  .title-meta{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
  .update-info{font-size:0.82rem;color:rgba(255,255,255,0.55)}
  .status-badge{display:flex;align-items:center;gap:7px;background:rgba(0,0,0,0.2);border:1px solid rgba(255,255,255,0.15);padding:5px 13px;border-radius:20px;font-size:0.78rem;color:rgba(255,255,255,0.65);letter-spacing:0.04em}
  .sdot{width:7px;height:7px;border-radius:50%;background:var(--mid-gray);flex-shrink:0}
  .sdot.live{background:#52d68a;animation:pulse 2.5s ease-in-out infinite}
  .sdot.loading{background:var(--gold)}
  .sdot.error{background:#e06060}
  @keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(82,214,138,0.4)}50%{opacity:.8;box-shadow:0 0 0 5px rgba(82,214,138,0)}}
  .main{max-width:1380px;margin:0 auto;padding:36px 44px 70px}
  .spinner{width:42px;height:42px;border:3px solid var(--light-gray);border-top-color:var(--green-mid);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
  @keyframes spin{to{transform:rotate(360deg)}}
  #dashboard{display:none;animation:fadeUp 0.4s ease}
  @keyframes fadeUp{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:translateY(0)}}
  .dash-controls{display:flex;align-items:center;gap:14px;margin-bottom:28px;flex-wrap:wrap;justify-content:space-between}
  .dash-controls-left{display:flex;gap:12px;align-items:center}
  .dash-source{font-size:0.78rem;color:var(--text-light)}
  .btn-outline{background:#fff;border:1.5px solid var(--border);color:var(--text-mid);font-family:'Source Sans 3',sans-serif;font-size:0.88rem;font-weight:600;padding:9px 20px;border-radius:5px;cursor:pointer;transition:all 0.2s}
  .btn-outline:hover{border-color:var(--green);color:var(--green);background:var(--green-xlight)}
  .section-header{display:flex;align-items:center;gap:14px;margin-bottom:18px;margin-top:36px}
  .section-header:first-child{margin-top:0}
  .section-title{font-family:'Merriweather',serif;font-size:1.05rem;font-weight:700;color:var(--green-dark);white-space:nowrap}
  .section-rule{flex:1;height:1px;background:var(--border)}
  .section-tag{font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-light);background:var(--light-gray);padding:4px 11px;border-radius:20px;white-space:nowrap}
  .cards-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(195px,1fr));gap:16px;margin-bottom:8px}
  .card{background:#fff;border:1px solid var(--border);border-radius:6px;padding:18px 20px 16px;position:relative;box-shadow:0 1px 5px rgba(0,0,0,0.05);transition:box-shadow 0.2s,transform 0.2s}
  .card:hover{box-shadow:0 5px 16px rgba(0,0,0,0.1);transform:translateY(-1px)}
  .card-accent{position:absolute;top:0;left:0;right:0;height:4px;border-radius:6px 6px 0 0;background:var(--mid-gray)}
  .card.bench .card-accent{background:var(--green-mid)}
  .card.positive .card-accent{background:var(--pos)}
  .card.negative .card-accent{background:var(--neg)}
  .card-label{font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;color:var(--text-light);margin-bottom:10px}
  .card-value{font-family:'Merriweather',serif;font-size:1.75rem;font-weight:700;line-height:1}
  .card-value.pos{color:var(--pos)}.card-value.neg{color:var(--neg)}.card-value.neu{color:var(--text-dark)}
  .card-type{font-size:0.75rem;color:var(--text-light);margin-top:5px}
  .card-divider{height:1px;background:var(--light-gray);margin:12px 0}
  .card-row{display:flex;justify-content:space-between;font-size:0.84rem;color:var(--text-light);margin-top:5px}
  .card-row .val{font-weight:700}
  .card-row .val.pos{color:var(--pos)}.card-row .val.neg{color:var(--neg)}.card-row .val.neu{color:var(--text-dark)}
  .chart-card{background:#fff;border:1px solid var(--border);border-radius:6px;padding:26px;box-shadow:0 1px 5px rgba(0,0,0,0.05)}
  .chart-card canvas{max-height:270px}
  .panel{background:#fff;border:1px solid var(--border);border-radius:6px;overflow:hidden;box-shadow:0 1px 5px rgba(0,0,0,0.05)}
  .panel-header{background:var(--green-dark);padding:14px 20px;display:flex;justify-content:space-between;align-items:center;gap:12px;border-bottom:2px solid var(--gold)}
  .panel-title{font-family:'Merriweather',serif;font-size:0.95rem;font-weight:400;color:#fff}
  .panel-return{font-weight:700;padding:3px 11px;border-radius:4px;font-size:0.88rem}
  .panel-return.pos{background:rgba(26,107,60,0.3);color:#90dfb0}
  .panel-return.neg{background:rgba(184,50,50,0.3);color:#f5a0a0}
  .panel-return.neu{background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.6)}
  .panel-bench{font-size:0.78rem;color:rgba(255,255,255,0.5)}
  .panel-bench .pos{color:#90dfb0;font-weight:700}.panel-bench .neg{color:#f5a0a0;font-weight:700}
  table{width:100%;border-collapse:collapse}
  thead{background:var(--green-xlight)}
  th{font-size:0.72rem;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;color:var(--green-dark);padding:11px 18px;text-align:right;border-bottom:2px solid var(--border)}
  th:first-child{text-align:left}
  td{font-size:0.9rem;padding:11px 18px;text-align:right;border-bottom:1px solid var(--light-gray);color:var(--text-mid)}
  td:first-child{text-align:left;color:var(--text-dark);font-weight:600}
  tr:last-child td{border-bottom:none}
  tr:hover td{background:var(--green-xlight)}
  td.pos{color:var(--pos);font-weight:700}td.neg{color:var(--neg);font-weight:700}
  .total-row td{background:var(--green-light)!important;font-weight:700;border-top:2px solid var(--border);border-bottom:none!important;color:var(--green-dark)}
  .total-row td.pos{color:var(--pos)}.total-row td.neg{color:var(--neg)}
  .ticker-tag{display:inline-block;background:var(--green-dark);color:#fff;font-size:0.75rem;font-weight:700;letter-spacing:0.06em;padding:2px 8px;border-radius:3px}
  .holdings-selector-row{display:flex;align-items:center;gap:14px;margin-bottom:20px;flex-wrap:wrap}
  .holdings-select{font-family:'Source Sans 3',sans-serif;font-size:0.92rem;font-weight:600;color:var(--text-dark);background:#fff;border:1.5px solid var(--border);border-radius:5px;padding:9px 36px 9px 14px;cursor:pointer;appearance:none;-webkit-appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237a917e' stroke-width='1.8' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;min-width:220px;transition:border-color 0.2s,box-shadow 0.2s}
  .holdings-select:hover{border-color:var(--green)}
  .holdings-select:focus{outline:none;border-color:var(--green);box-shadow:0 0 0 3px rgba(45,106,79,0.12)}
  .holdings-panel-wrap{animation:fadeUp 0.25s ease}
  .site-footer{background:var(--green-dark);border-top:3px solid var(--gold);padding:22px 44px;text-align:center;font-size:0.75rem;color:rgba(255,255,255,0.35);line-height:1.9;margin-top:60px}
</style>
</head>
<body>
<div class="site-header">
  <div class="logo-area">
    <img src="https://nelsoncorp.com/wp-content/uploads/2025/06/NelsonCorp-Logo-2025.png" alt="NelsonCorp" class="logo-img" onerror="this.style.display='none';document.querySelector('.logo-fallback').style.display='block'">
    <div class="logo-fallback" style="display:none;font-family:'Merriweather',serif;color:#fff;font-size:1.1rem;font-weight:700">NelsonCorp Wealth Management</div>
    <div class="logo-divider"></div>
    <div class="logo-sub">Portfolio Analytics</div>
  </div>
  <div class="header-date" id="header-date"></div>
</div>
<div class="title-bar">
  <h1>Daily Portfolio <span>Performance Dashboard</span></h1>
  <div class="title-meta">
    <div class="status-badge"><span class="sdot loading" id="sdot"></span><span id="stext">Connecting...</span></div>
    <div class="update-info" id="update-info"></div>
  </div>
</div>
<div class="main">
  <div id="price-loading-banner" style="background:var(--green-xlight);border:1px solid var(--border);border-radius:6px;padding:12px 20px;margin-bottom:20px;display:flex;align-items:center;gap:10px;font-size:0.85rem;color:var(--text-mid);">
    <div class="spinner" style="width:18px;height:18px;border-width:2px;margin:0;flex-shrink:0;"></div>
    <span id="banner-text">Loading portfolio data...</span>
  </div>
  <div id="dashboard">
    <div class="dash-controls">
      <div class="dash-controls-left">
        <button class="btn-outline" onclick="fetchAllPrices()">&#8635; Refresh Prices</button>
        <label class="btn-outline" style="font-size:0.8rem;padding:8px 14px;cursor:pointer;">
          &#128194; Upload Updated Spreadsheet
          <input type="file" id="file-input" accept=".xlsx,.xls" style="display:none">
        </label>
        <button class="btn-outline" style="font-size:0.8rem;padding:8px 14px;color:var(--neg);border-color:var(--neg);opacity:0.7;" onclick="resetYTDCache()" title="Clears cached YTD values and reverts to last uploaded spreadsheet">&#10006; Reset YTD Cache</button>
      </div>
      <div class="dash-source" id="dash-source"></div>
    </div>
    <div class="section-header"><div class="section-title">Market Benchmarks</div><div class="section-rule"></div><div class="section-tag">Daily &middot; YTD</div></div>
    <div class="cards-row" id="bench-cards"></div>
    <div class="section-header"><div class="section-title">Portfolio Models</div><div class="section-rule"></div><div class="section-tag">Daily &middot; YTD &middot; vs Benchmark</div></div>
    <div class="cards-row" id="model-cards"></div>
    <div class="section-header"><div class="section-title">Performance Comparison</div><div class="section-rule"></div></div>
    <div class="chart-card" style="margin-bottom:16px">
      <div style="font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;color:var(--text-light);margin-bottom:14px">Daily Return</div>
      <canvas id="perf-chart-daily"></canvas>
    </div>
    <div class="chart-card" style="margin-bottom:8px">
      <div style="font-size:0.75rem;font-weight:700;text-transform:uppercase;letter-spacing:0.09em;color:var(--text-light);margin-bottom:14px">Year-to-Date Return</div>
      <canvas id="perf-chart-ytd"></canvas>
    </div>
    <div class="section-header"><div class="section-title">Holdings Detail</div><div class="section-rule"></div></div>
    <div class="holdings-selector-row">
      <select class="holdings-select" id="holdings-select" onchange="showSelectedPortfolio()">
        <option value="">&#8212; Select a portfolio &#8212;</option>
      </select>
    </div>
    <div id="holdings-panels"></div>
  </div>
</div>
<div class="site-footer">
  NelsonCorp Wealth Management &nbsp;&middot;&nbsp; Internal Use Only &nbsp;&middot;&nbsp; 880 13th Avenue North, Clinton, Iowa 52732<br>
  Securities offered through Registered Representatives of Cambridge Investment Research, Inc., a broker-dealer, member FINRA/SIPC.
  Advisory services through Cambridge Investment Research Advisors, Inc., a Registered Investment Advisor.
</div>
<script>
// =================================================================
// NELSONCORP DASHBOARD - fully spreadsheet-driven
//
// HOW TO MAKE CHANGES (no code edits needed):
//   Add/remove benchmarks  -> edit "Benchmarks" sheet, upload .xlsx to GitHub repo
//   Add/remove/edit models -> edit "NelsonCorp" sheet, upload .xlsx to GitHub repo
//   Update YTD figures     -> click "Upload Updated Spreadsheet" on the page
//
// SPREADSHEET STRUCTURE (keep sheet names exactly as shown):
//
// "Benchmarks" sheet - repeating block per benchmark:
//   Row: Display name      e.g. "S&P 500"
//   Row: Header            Ticker / Weight / Return / Total Return
//   Row: Data              SPYM / 1 / [formula] / [formula]
//   Row: Total             blank / [SUM] / blank / [SUM]
//   Row: blank separator
//   ...next benchmark...
//
// "NelsonCorp" sheet - repeating block per model:
//   Row: Model name        e.g. "MODERATE"
//   Row: Header            Ticker / Weight / Return / Total Return / +/- Benchmark
//   Rows: Holdings         TICKER / weight / [formula] / [formula] / blank
//   Row: Total             blank / [SUM] / blank / [SUM] / [bench diff]
//   Row: blank separator
//   ...next model...
//
// "Dashboard" sheet - YTD values read on manual upload:
//   Row 1: Headers (Model / blank / Daily / +/-Bench / YTD / ...)
//   Benchmark rows: col A=name, col D=blank, col E=YTD decimal
//   Model rows:     col A=name, col D=value, col E=YTD decimal
//   Benchmark rows must appear BEFORE model rows.
//   ORDER of benchmarks in Dashboard must match order in Benchmarks sheet.
//
// The FIRST benchmark in the Benchmarks sheet is the primary comparison
// index used for all "vs Benchmark" calculations.
// =================================================================

const FINNHUB_KEY = 'd6b2sl9r01qnr27jfc2gd6b2sl9r01qnr27jfc30';
const REFRESH_MS  = 60 * 1000;

// Update this if you rename the Excel file in the repo:
const GITHUB_EXCEL =
  'https://raw.githubusercontent.com/nelsoncorp/portfolio-dashboard/main/NCorp%20Daily%20Portfolio%20Performance.xlsx';

// State
// BENCHMARKS[i] = { name (display), ticker (Finnhub), dashName (Dashboard col A) }
let BENCHMARKS = [];
let etfPrices  = {};   // ticker -> { daily }
let benchYTD   = {};   // dashName -> YTD decimal (raw from spreadsheet = prior day's close)
let modelYTD   = {};   // model name (from Dashboard col A) -> YTD decimal (raw from spreadsheet)
let models     = [];   // [{ name, holdings: [{ ticker, weight }] }]
let eodCache   = null; // { date: "YYYY-MM-DD", benchYTD: {}, modelYTD: {} } — locked-in close values
let chartInst  = null;
let priceTimer = null;

function primaryTicker()   { return BENCHMARKS.length ? BENCHMARKS[0].ticker   : null; }
function primaryDashName() { return BENCHMARKS.length ? BENCHMARKS[0].dashName : null; }
function primaryName()     { return BENCHMARKS.length ? BENCHMARKS[0].name     : 'Benchmark'; }

// Init
document.getElementById('header-date').textContent = new Date().toLocaleDateString('en-US',{
  weekday:'long',year:'numeric',month:'long',day:'numeric'
});
try {
  const saved = localStorage.getItem('ncorp_ytd');
  if (saved) { const p=JSON.parse(saved); benchYTD=p.benchYTD||{}; modelYTD=p.modelYTD||{}; }
} catch(e){}
try {
  const savedEOD = localStorage.getItem('ncorp_ytd_eod');
  if (savedEOD) {
    const parsed = JSON.parse(savedEOD);
    // Discard the cache if it's older than the most recent trading day.
    // This prevents stale or corrupted cache values from persisting across
    // multiple days and causing wrong YTD numbers on load.
    if (parsed && parsed.date && isRecentTradingDay(parsed.date)) {
      eodCache = parsed;
    } else {
      localStorage.removeItem('ncorp_ytd_eod');
    }
  }
} catch(e){}

// Returns true if dateStr ("YYYY-MM-DD") is from the most recent trading day
// (today if it's a weekday, or last Friday if today is a weekend/Monday pre-open).
function isRecentTradingDay(dateStr) {
  const now = new Date();
  const etStr = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
  const et = new Date(etStr);
  // Walk back from today to find the most recent weekday
  const d = new Date(et);
  // If before market open on a weekday, the most recent trading day is yesterday
  const totalMins = d.getHours() * 60 + d.getMinutes();
  if (d.getDay() !== 0 && d.getDay() !== 6 && totalMins < 570) d.setDate(d.getDate() - 1);
  // Keep stepping back until we land on a weekday
  while (d.getDay() === 0 || d.getDay() === 6) d.setDate(d.getDate() - 1);
  const recentKey = d.getFullYear() + '-' +
    String(d.getMonth() + 1).padStart(2,'0') + '-' +
    String(d.getDate()).padStart(2,'0');
  return dateStr === recentKey;
}

window.addEventListener('DOMContentLoaded', async () => {
  document.getElementById('dashboard').style.display = 'block';
  setBanner('Loading portfolio data from GitHub...');
  await loadGithubExcel();
  fetchAllPrices();
});

// Load from GitHub (weights + structure only, no YTD)
async function loadGithubExcel() {
  try {
    const res = await fetch(GITHUB_EXCEL + '?t=' + Date.now());
    if (!res.ok) throw new Error('HTTP ' + res.status);
    parseExcel(await res.arrayBuffer(), 'github', false);
    console.log('GitHub Excel loaded OK');
  } catch(e) {
    console.warn('Could not load GitHub Excel:', e);
    setBanner('Could not reach GitHub. Upload the spreadsheet manually to populate the dashboard.');
    setTimeout(hideBanner, 6000);
  }
}

// Manual upload (weights + structure + YTD)
document.getElementById('file-input').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => parseExcel(ev.target.result, file.name, true);
  reader.readAsArrayBuffer(file);
  e.target.value = '';
});

// Master parse function
function parseExcel(buffer, source, updateYTD) {
  const wb = XLSX.read(buffer, { type:'array' });
  const sheets = {};
  wb.SheetNames.forEach(n => {
    sheets[n] = XLSX.utils.sheet_to_json(wb.Sheets[n], { header:1, defval:null, raw:true });
  });

  // 1. Benchmarks sheet -> [{ name, ticker }] in order
  const benchFromSheet = parseBenchmarksSheet(sheets['Benchmarks'] || []);

  // 2. Dashboard sheet -> benchmark dashNames + YTD (in order), model YTD map
  const { benchDashRows, modelYTDMap } = parseDashboardSheet(sheets['Dashboard'] || []);

  // 3. Zip by position - handles name mismatches (e.g. "Dow Jones Industrial Average" vs "Dow")
  BENCHMARKS = benchFromSheet.map((b, i) => ({
    name:     b.name,
    ticker:   b.ticker,
    dashName: benchDashRows[i] ? benchDashRows[i].dashName : b.name,
  }));

  // 4. NelsonCorp sheet -> models
  const parsedModels = parseNelsonCorpSheet(sheets['NelsonCorp'] || []);
  if (parsedModels.length) models = parsedModels;

  // 5. Persist YTD on manual upload
  if (updateYTD) {
    const newBenchYTD = {};
    benchDashRows.forEach(r => { newBenchYTD[r.dashName] = r.ytd; });
    benchYTD = newBenchYTD;
    modelYTD = modelYTDMap;
    // Clear EOD cache — the new spreadsheet is now the source of truth
    eodCache = null;
    try { localStorage.removeItem('ncorp_ytd_eod'); } catch(e){}
    try { localStorage.setItem('ncorp_ytd', JSON.stringify({ benchYTD, modelYTD })); } catch(e){}
    document.getElementById('update-info').textContent =
      'YTD updated ' + new Date().toLocaleTimeString('en-US',{timeStyle:'short'});
  }

  document.getElementById('dash-source').textContent = updateYTD
    ? 'Prices auto-refresh every minute  YTD loaded from: ' + source
    : 'Prices auto-refresh every minute  YTD: ' +
      (Object.keys(modelYTD).length ? 'loaded' : 'upload spreadsheet to populate YTD');

  console.log('Benchmarks:', BENCHMARKS.map(b => b.name + ' (' + b.ticker + ') -> "' + b.dashName + '"'));
  console.log('Models:', models.map(m => m.name + ' (' + m.holdings.length + ' holdings)'));
  renderAll();
}

// Parse "Benchmarks" sheet
// Pattern: name row (col A=text, col B=null) -> header (col A="Ticker") ->
//          data row (col A=ticker, col B=1) -> total row (col A=null) -> blank
function parseBenchmarksSheet(rows) {
  const result = [];
  let pendingName = null;
  for (const r of rows) {
    const colA = String(r[0] || '').trim();
    const colB = r[1];
    if (colA === 'Ticker') continue;
    if (colA && (colB === null || colB === '')) { pendingName = colA; continue; }
    if (colA && pendingName && !isNaN(parseFloat(colB))) {
      result.push({ name: pendingName, ticker: colA.toUpperCase() });
      pendingName = null;
    }
    if (!colA) pendingName = null;
  }
  return result;
}

// Parse "Dashboard" sheet
// Benchmark rows: col D (idx 3) = null -> { dashName, ytd }
// Model rows:     col D (idx 3) = value -> modelYTDMap[name] = ytd
function parseDashboardSheet(rows) {
  const benchDashRows = [];
  const modelYTDMap   = {};
  for (let i = 1; i < rows.length; i++) {
    const r    = rows[i];
    const name = String(r[0] || '').trim();
    if (!name || name === 'Model') continue;
    const ytd       = parseFloat(r[4]);
    const benchDiff = r[3];
    if (isNaN(ytd)) continue;
    if (benchDiff === null || benchDiff === '') {
      benchDashRows.push({ dashName: name, ytd });
    } else {
      modelYTDMap[name] = ytd;
    }
  }
  return { benchDashRows, modelYTDMap };
}

// Parse "NelsonCorp" sheet
// Pattern: name row (col A=text, col B=null) -> header (col A="Ticker") ->
//          holding rows (col A=ticker, col B=weight) -> total row (col A=null) -> blank
function parseNelsonCorpSheet(rows) {
  const result  = [];
  let modelName = null;
  let holdings  = [];
  const save = () => { if (modelName && holdings.length) result.push({ name: toTitleCase(modelName), holdings }); };
  for (const r of rows) {
    const colA = String(r[0] || '').trim();
    const colB = r[1];
    if (colA === 'Ticker') continue;
    if (colA && (colB === null || colB === '')) { save(); modelName = colA; holdings = []; continue; }
    if (!colA) continue;
    if (colA && modelName) {
      const weight = parseFloat(colB);
      if (!isNaN(weight) && weight > 0) holdings.push({ ticker: colA.toUpperCase(), weight });
    }
  }
  save();
  return result;
}

function toTitleCase(str) {
  return str.replace(/\w\S*/g, w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());
}

// Fetch live prices from Finnhub
function allTickers() {
  const s = new Set();
  BENCHMARKS.forEach(b => s.add(b.ticker));
  models.forEach(m => m.holdings.forEach(h => { if (h.ticker !== 'CASH') s.add(h.ticker); }));
  return [...s];
}

async function fetchAllPrices() {
  setBanner('Fetching live prices...');
  setStatus('loading', 'Fetching prices...');
  const tickers = allTickers();
  const newPrices = {};
  let fetched = 0;
  for (const ticker of tickers) {
    try {
      const res = await fetch('https://finnhub.io/api/v1/quote?symbol=' + ticker + '&token=' + FINNHUB_KEY);
      if (!res.ok) continue;
      const q = await res.json();
      if (!q || !q.c || !q.pc) continue;
      newPrices[ticker] = { daily: (q.c - q.pc) / q.pc };
      fetched++;
    } catch(e) { console.warn('Finnhub failed for', ticker, e); }
  }
  hideBanner();
  if (fetched === 0) {
    setStatus('error', 'Price fetch failed');
    document.getElementById('update-info').textContent = 'Could not reach Finnhub - check connection';
    return;
  }
  etfPrices = newPrices;
  if (isMarketOpen()) {
    setStatus('live', 'Live - Finnhub (' + fetched + '/' + tickers.length + ' tickers)');
    document.getElementById('update-info').textContent =
      'Prices updated ' + new Date().toLocaleTimeString('en-US',{timeStyle:'short'});
  } else if (isTradingDayAfterOpen()) {
    saveEODCache();
    setStatus('loading', 'Market Closed — YTD reflects today\'s close');
    document.getElementById('update-info').textContent =
      'Market closed · YTD updated through today\'s close · ' +
      new Date().toLocaleTimeString('en-US',{timeStyle:'short'});
  } else {
    setStatus('loading', 'Market Closed — YTD as of prior close');
    document.getElementById('update-info').textContent =
      eodCache
        ? 'Pre-market · YTD locked in from ' + eodCache.date + ' close'
        : 'Pre-market · YTD reflects prior trading day\'s close';
  }
  renderAll();
  clearInterval(priceTimer);
  priceTimer = setInterval(fetchAllPrices, REFRESH_MS);
}

// Returns true if the US equity market is currently open (Mon–Fri, 9:30–16:00 ET)
function isMarketOpen() {
  const now = new Date();
  const etStr = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
  const et = new Date(etStr);
  const day = et.getDay(); // 0=Sun, 6=Sat
  if (day === 0 || day === 6) return false;
  const totalMins = et.getHours() * 60 + et.getMinutes();
  return totalMins >= 570 && totalMins < 960; // 9:30am=570, 4:00pm=960
}

// Returns true on weekdays from market open (9:30am) through end of day.
// This means after the close we still compound today's daily return, because
// Finnhub's prices after 4pm ET reflect today's actual closing prices — the
// YTD base from the spreadsheet is still yesterday's close until the user
// re-uploads the next morning.
function isTradingDayAfterOpen() {
  const now = new Date();
  const etStr = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
  const et = new Date(etStr);
  const day = et.getDay();
  if (day === 0 || day === 6) return false;
  const totalMins = et.getHours() * 60 + et.getMinutes();
  return totalMins >= 570; // 9:30am onwards — covers market hours AND post-close
}

function calcModelDaily(model) {
  let total = 0;
  for (const h of model.holdings) {
    if (h.ticker === 'CASH') continue;
    const p = etfPrices[h.ticker];
    if (p) total += h.weight * p.daily;
  }
  return total;
}

// Compute all YTD values using today's closing prices and save to localStorage.
// Called after the market closes so the dashboard can show correct YTD over
// the weekend and pre-market the next morning without needing a spreadsheet upload.
function saveEODCache() {
  const etStr = new Date().toLocaleString('en-US', { timeZone: 'America/New_York' });
  const et = new Date(etStr);
  const dateKey = et.getFullYear() + '-' +
    String(et.getMonth() + 1).padStart(2,'0') + '-' +
    String(et.getDate()).padStart(2,'0');

  const eodBenchYTD = {};
  BENCHMARKS.forEach(b => {
    const base  = benchYTD[b.dashName] ?? null;
    const daily = etfPrices[b.ticker] ? etfPrices[b.ticker].daily : null;
    if (base != null) eodBenchYTD[b.dashName] = daily != null ? (1 + base) * (1 + daily) - 1 : base;
  });

  const eodModelYTD = {};
  models.forEach(m => {
    const base = getModelYTD(m.name);
    if (base != null) eodModelYTD[m.name] = (1 + base) * (1 + calcModelDaily(m)) - 1;
  });

  eodCache = { date: dateKey, benchYTD: eodBenchYTD, modelYTD: eodModelYTD };
  try { localStorage.setItem('ncorp_ytd_eod', JSON.stringify(eodCache)); } catch(e){}
}

// Return the best available YTD base for a benchmark.
// The EOD cache is always preferred over the raw spreadsheet when it exists —
// this covers weekends, pre-market, AND the case where the market has opened
// but a fresh spreadsheet hasn't been uploaded yet (e.g. forgot to upload before
// the open). The cache is only cleared on a manual spreadsheet upload, at which
// point the fresh data immediately takes over as the compounding base.
function getEffectiveBenchYTD(dashName) {
  if (eodCache && eodCache.benchYTD[dashName] != null) {
    return eodCache.benchYTD[dashName];
  }
  return benchYTD[dashName] ?? null;
}

// Same logic for model YTD.
function getEffectiveModelYTD(name) {
  if (eodCache && eodCache.modelYTD[name] != null) {
    return eodCache.modelYTD[name];
  }
  return getModelYTD(name);
}


// Compound today's live daily return on top of the effective YTD base.
// Only compound while the market is actually open. Post-close, the EOD cache
// already has today's return baked in so returning the base as-is is correct.
// On weekends and pre-market the same logic applies — base is already correct.
function realtimeYTD(ytdBase, daily) {
  if (ytdBase == null) return null;
  if (!isMarketOpen() || daily == null) return ytdBase;
  return (1 + ytdBase) * (1 + daily) - 1;
}

function getModelYTD(name) {
  return modelYTD[name] ?? modelYTD[toTitleCase(name)] ?? null;
}

function renderAll() {
  renderBenchCards();
  renderModelCards();
  renderChart();
  renderHoldingsDropdown();
}

function renderBenchCards() {
  const row = document.getElementById('bench-cards');
  row.innerHTML = '';
  BENCHMARKS.forEach(b => {
    const p = etfPrices[b.ticker];
    const daily = p ? p.daily : null;
    const ytd = realtimeYTD(getEffectiveBenchYTD(b.dashName), daily);
    const noYTD = getEffectiveBenchYTD(b.dashName) == null;
    const div = document.createElement('div');
    div.className = 'card bench ' + (daily > 0 ? 'positive' : daily < 0 ? 'negative' : '');
    div.innerHTML =
      '<div class="card-accent"></div>' +
      '<div class="card-label">' + b.name + '</div>' +
      '<div class="card-value ' + cc(daily) + '">' + fmt(daily) + '</div>' +
      '<div class="card-type">Daily Return - ' + b.ticker + '</div>' +
      '<div class="card-divider"></div>' +
      '<div class="card-row"><span>YTD</span><span class="val ' + cc(ytd) + '">' +
        (noYTD ? '<span style="color:var(--text-light);font-weight:400;font-size:0.78rem">Upload Spreadsheet</span>' : fmt(ytd)) +
      '</span></div>';
    row.appendChild(div);
  });
}

function renderModelCards() {
  const row = document.getElementById('model-cards');
  row.innerHTML = '';
  const pt = primaryTicker();
  const pd = primaryDashName();
  const pl = primaryName();
  const primDaily = pt ? (etfPrices[pt] ? etfPrices[pt].daily : null) : null;
  const primYTD   = realtimeYTD(getEffectiveBenchYTD(pd), primDaily);
  models.forEach(m => {
    const daily      = calcModelDaily(m);
    const dailyBench = primDaily != null ? daily - primDaily : null;
    const ytdBase    = getEffectiveModelYTD(m.name);
    const ytd        = realtimeYTD(ytdBase, daily);
    const ytdBench   = (ytd != null && primYTD != null) ? ytd - primYTD : null;
    const noYTD      = ytdBase == null;
    const div = document.createElement('div');
    div.className = 'card ' + (daily > 0 ? 'positive' : daily < 0 ? 'negative' : '');
    div.innerHTML =
      '<div class="card-accent"></div>' +
      '<div class="card-label">' + m.name + '</div>' +
      '<div class="card-value ' + cc(daily) + '">' + fmt(daily) + '</div>' +
      '<div class="card-type">' + (isMarketOpen() ? 'Daily Return (Live)' : isTradingDayAfterOpen() ? 'Daily Return (Today\'s Close)' : 'Daily Return (Prior Close)') + '</div>' +
      '<div class="card-divider"></div>' +
      '<div class="card-row"><span>vs ' + pl + '</span><span class="val ' + cc(dailyBench) + '">' + fmt(dailyBench) + '</span></div>' +
      '<div class="card-row"><span>YTD</span><span class="val ' + cc(ytd) + '">' +
        (noYTD ? '<span style="color:var(--text-light);font-weight:400;font-size:0.78rem">Upload Spreadsheet</span>' : fmt(ytd)) +
      '</span></div>' +
      (ytdBench != null ? '<div class="card-row"><span>YTD vs ' + pl + '</span><span class="val ' + cc(ytdBench) + '">' + fmt(ytdBench) + '</span></div>' : '');
    row.appendChild(div);
  });
}

let chartDaily = null, chartYTD = null;

function renderChart() {
  // Build data for both charts
  const all = [
    ...BENCHMARKS.map(b => ({
      label: b.name,
      daily: etfPrices[b.ticker] ? etfPrices[b.ticker].daily : 0,
      ytd: realtimeYTD(getEffectiveBenchYTD(b.dashName), etfPrices[b.ticker] ? etfPrices[b.ticker].daily : null),
      isBench: true
    })),
    ...models.map(m => {
      const d = calcModelDaily(m);
      return { label: m.name, daily: d, ytd: realtimeYTD(getEffectiveModelYTD(m.name), d), isBench: false };
    })
  ];

  const labels = all.map(d => d.label);
  const sharedOptions = {
    responsive: true,
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: '#1b4332', borderColor: '#c9a84c', borderWidth: 1,
        titleColor: '#fff', titleFont: { family: 'Source Sans 3', size: 13 },
        bodyColor: '#d8f3dc', bodyFont: { family: 'Source Sans 3', size: 13 }, padding: 12,
        callbacks: {
          label: c => c.parsed.y == null
            ? ' -'
            : ' ' + (c.parsed.y > 0 ? '+' : '') + c.parsed.y.toFixed(2) + '%'
        }
      }
    },
    scales: {
      x: { ticks: { color: '#7a917e', font: { family: 'Source Sans 3', size: 12 } }, grid: { color: '#eef0eb' } },
      y: { ticks: { color: '#7a917e', font: { family: 'Source Sans 3', size: 12 }, callback: v => v.toFixed(2) + '%' }, grid: { color: '#eef0eb' } }
    }
  };

  // ── DAILY CHART ──
  if (chartDaily) { chartDaily.destroy(); chartDaily = null; }
  chartDaily = new Chart(document.getElementById('perf-chart-daily'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data: all.map(d => +(d.daily * 100).toFixed(3)),
        backgroundColor: all.map(d => d.isBench
          ? (d.daily >= 0 ? 'rgba(64,145,108,0.8)' : 'rgba(184,50,50,0.65)')
          : (d.daily >= 0 ? 'rgba(27,67,50,0.9)'   : 'rgba(184,50,50,0.65)')),
        borderRadius: 4, barPercentage: 0.6
      }]
    },
    options: sharedOptions
  });

  // ── YTD CHART ──
  if (chartYTD) { chartYTD.destroy(); chartYTD = null; }
  // Separate colors: benchmarks in green-mid, models in green-dark; grey if no YTD data
  chartYTD = new Chart(document.getElementById('perf-chart-ytd'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data: all.map(d => d.ytd != null ? +(d.ytd * 100).toFixed(2) : null),
        backgroundColor: all.map(d => {
          if (d.ytd == null) return 'rgba(196,203,191,0.5)';
          return d.isBench
            ? (d.ytd >= 0 ? 'rgba(64,145,108,0.8)' : 'rgba(184,50,50,0.65)')
            : (d.ytd >= 0 ? 'rgba(201,168,76,0.85)' : 'rgba(184,50,50,0.65)');
        }),
        borderRadius: 4, barPercentage: 0.6
      }]
    },
    options: {
      ...sharedOptions,
      plugins: {
        ...sharedOptions.plugins,
        tooltip: {
          ...sharedOptions.plugins.tooltip,
          callbacks: {
            label: c => c.parsed.y == null
              ? ' No YTD data - upload spreadsheet'
              : ' ' + (c.parsed.y > 0 ? '+' : '') + c.parsed.y.toFixed(2) + '%'
          }
        }
      }
    }
  });
}

function renderHoldingsDropdown() {
  const select = document.getElementById('holdings-select');
  const prev = select.value;
  select.innerHTML = '<option value="">- Select a portfolio -</option>';
  models.forEach((m,i) => { const o=document.createElement('option'); o.value=i; o.textContent=m.name; select.appendChild(o); });
  select.value = (prev!==''&&select.querySelector('option[value="'+prev+'"]')) ? prev : '0';
  showSelectedPortfolio();
}

function showSelectedPortfolio() {
  const select=document.getElementById('holdings-select'), container=document.getElementById('holdings-panels');
  const idx=select.value;
  if (idx===''||!models[idx]) { container.innerHTML=''; return; }
  const m=models[idx], pt=primaryTicker(), pl=primaryName();
  const primDaily=pt?(etfPrices[pt]?etfPrices[pt].daily:null):null;
  let liveTotal=0, rows='';
  m.holdings.forEach(h => {
    const liveRet=(h.ticker!=='CASH'&&etfPrices[h.ticker])?etfPrices[h.ticker].daily:0;
    const contrib=h.weight*liveRet; liveTotal+=contrib;
    rows+='<tr><td><span class="ticker-tag">'+h.ticker+'</span></td><td>'+(h.weight*100).toFixed(1)+'%</td><td class="'+cc(liveRet)+'">'+(h.ticker==='CASH'?'-':fmt(liveRet))+'</td><td class="'+cc(contrib)+'">'+(h.ticker==='CASH'?'-':fmt(contrib))+'</td></tr>';
  });
  const liveBench=primDaily!=null?liveTotal-primDaily:null;
  rows+='<tr class="total-row"><td>Portfolio Total</td><td></td><td></td><td class="'+cc(liveTotal)+'">'+fmt(liveTotal)+'</td></tr>';
  const benchStr=liveBench!=null?'<span class="panel-bench" style="margin-left:10px">vs '+pl+' <span class="'+cc(liveBench)+'">'+fmt(liveBench)+'</span></span>':'';
  container.innerHTML='';
  const wrap=document.createElement('div'); wrap.className='holdings-panel-wrap';
  wrap.innerHTML='<div class="panel"><div class="panel-header"><span class="panel-title">'+m.name+'</span><div style="display:flex;align-items:center;gap:10px"><span class="panel-return '+cc(liveTotal)+'">'+fmt(liveTotal)+'</span>'+benchStr+'</div></div><table><thead><tr><th>Ticker</th><th>Weight</th><th>Return</th><th>Contribution</th></tr></thead><tbody>'+rows+'</tbody></table></div>';
  container.appendChild(wrap);
}

function resetYTDCache() {
  if (!confirm('Clear the cached YTD values? The dashboard will revert to the last uploaded spreadsheet values.')) return;
  eodCache = null;
  try { localStorage.removeItem('ncorp_ytd_eod'); } catch(e){}
  renderAll();
  document.getElementById('update-info').textContent = 'YTD cache cleared — showing spreadsheet values';
}
function setStatus(state,text){document.getElementById('sdot').className='sdot '+state;document.getElementById('stext').textContent=text;}
function setBanner(msg){document.getElementById('banner-text').textContent=msg;document.getElementById('price-loading-banner').style.display='flex';}
function hideBanner(){document.getElementById('price-loading-banner').style.display='none';}
function fmt(val,dec=2){if(val==null||isNaN(val))return '-';const p=val*100;return(p>0?'+':'')+p.toFixed(dec)+'%';}
function cc(val){if(val==null||isNaN(val))return 'neu';return val>0?'pos':val<0?'neg':'neu';}
</script>
</body>
</html>
