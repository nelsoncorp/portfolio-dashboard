<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Portfolio Performance — NelsonCorp Wealth Management</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@300;400;700&family=Source+Sans+3:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --green:#2d6a4f;--green-dark:#1b4332;--green-mid:#40916c;--green-light:#d8f3dc;
    --green-xlight:#f0faf2;--gold:#c9a84c;--gold-light:#f0d080;--white:#ffffff;
    --off-white:#f4f6f2;--light-gray:#eaede6;--mid-gray:#c4cbbf;--border:#dde5d8;
    --text-dark:#1b2e1f;--text-mid:#3d5240;--text-light:#7a917e;--pos:#1a6b3c;--neg:#b83232;
    --shadow-sm:0 1px 3px rgba(27,67,50,0.06),0 1px 2px rgba(27,67,50,0.04);
    --shadow-md:0 4px 12px rgba(27,67,50,0.1),0 2px 4px rgba(27,67,50,0.06);
    --shadow-lg:0 10px 30px rgba(27,67,50,0.12),0 4px 8px rgba(27,67,50,0.06);
    --radius:8px;
  }
  *{box-sizing:border-box;margin:0;padding:0}
  body{
    font-family:'Source Sans 3',sans-serif;font-size:16px;color:var(--text-dark);min-height:100vh;
    background-color:var(--off-white);
    background-image:
      radial-gradient(circle at 20% 0%, rgba(45,106,79,0.06) 0%, transparent 50%),
      radial-gradient(circle at 80% 100%, rgba(201,168,76,0.05) 0%, transparent 40%),
      url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='none' fill-rule='evenodd'%3E%3Cg fill='%232d6a4f' fill-opacity='0.018'%3E%3Cpath d='M36 34v-4h-2v4h-4v2h4v4h2v-4h4v-2h-4zm0-30V0h-2v4h-4v2h4v4h2V6h4V4h-4zM6 34v-4H4v4H0v2h4v4h2v-4h4v-2H6zM6 4V0H4v4H0v2h4v4h2V6h4V4H6z'/%3E%3C/g%3E%3C/g%3E%3C/svg%3E");
  }

  /* ── HEADER ── */
  .site-header{
    background:linear-gradient(135deg, #152d22 0%, var(--green-dark) 60%, #22553d 100%);
    padding:0 48px;display:flex;align-items:center;justify-content:space-between;
    height:80px;border-bottom:3px solid var(--gold);flex-wrap:wrap;gap:10px;
    box-shadow:0 2px 12px rgba(0,0,0,0.25);position:relative;z-index:10;
  }
  .site-header::after{
    content:'';position:absolute;inset:0;
    background:linear-gradient(90deg, rgba(201,168,76,0.06) 0%, transparent 60%);
    pointer-events:none;
  }
  .logo-area{display:flex;align-items:center;gap:18px;position:relative;z-index:1}
  .logo-img{height:46px;object-fit:contain;filter:brightness(0) invert(1)}
  .logo-divider{width:1px;height:34px;background:rgba(255,255,255,0.18)}
  .logo-sub{font-size:0.78rem;color:rgba(255,255,255,0.45);letter-spacing:0.14em;text-transform:uppercase;font-weight:600}
  .header-date{font-size:0.84rem;color:rgba(255,255,255,0.45);position:relative;z-index:1;letter-spacing:0.01em}

  /* ── TITLE BAR ── */
  .title-bar{
    background:linear-gradient(135deg, #2a7a5c 0%, var(--green) 50%, #336b55 100%);
    padding:18px 48px;display:flex;align-items:center;justify-content:space-between;
    flex-wrap:wrap;gap:12px;border-bottom:1px solid rgba(255,255,255,0.1);
    box-shadow:0 2px 8px rgba(0,0,0,0.12);
  }
  .title-bar h1{font-family:'Merriweather',serif;font-size:1.4rem;font-weight:300;color:rgba(255,255,255,0.95);letter-spacing:0.01em}
  .title-bar h1 span{color:var(--gold-light);font-weight:700}
  .title-meta{display:flex;align-items:center;gap:14px;flex-wrap:wrap}
  .update-info{font-size:0.8rem;color:rgba(255,255,255,0.5)}
  .status-badge{
    display:flex;align-items:center;gap:7px;
    background:rgba(0,0,0,0.18);border:1px solid rgba(255,255,255,0.12);
    padding:5px 14px;border-radius:20px;font-size:0.76rem;
    color:rgba(255,255,255,0.65);letter-spacing:0.05em;backdrop-filter:blur(4px);
  }
  .sdot{width:7px;height:7px;border-radius:50%;background:var(--mid-gray);flex-shrink:0}
  .sdot.live{background:#52d68a;animation:pulse 2.5s ease-in-out infinite}
  .sdot.loading{background:var(--gold)}
  .sdot.error{background:#e06060}
  @keyframes pulse{0%,100%{opacity:1;box-shadow:0 0 0 0 rgba(82,214,138,0.5)}50%{opacity:.85;box-shadow:0 0 0 6px rgba(82,214,138,0)}}

  /* ── LAYOUT ── */
  .main{max-width:1380px;margin:0 auto;padding:40px 48px 80px}
  .spinner{width:42px;height:42px;border:3px solid var(--light-gray);border-top-color:var(--green-mid);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 16px}
  @keyframes spin{to{transform:rotate(360deg)}}
  #dashboard{display:none;animation:fadeUp 0.5s ease}
  @keyframes fadeUp{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

  /* ── CONTROLS ── */
  .dash-controls{display:flex;align-items:center;gap:14px;margin-bottom:32px;flex-wrap:wrap;justify-content:space-between}
  .dash-controls-left{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .dash-source{font-size:0.76rem;color:var(--text-light)}
  .btn-outline{
    background:#fff;border:1.5px solid var(--border);color:var(--text-mid);
    font-family:'Source Sans 3',sans-serif;font-size:0.86rem;font-weight:600;
    padding:9px 18px;border-radius:6px;cursor:pointer;
    transition:all 0.18s ease;box-shadow:var(--shadow-sm);
    letter-spacing:0.01em;
  }
  .btn-outline:hover{
    border-color:var(--green-mid);color:var(--green);
    background:var(--green-xlight);box-shadow:var(--shadow-md);
    transform:translateY(-1px);
  }
  .btn-outline:active{transform:translateY(0);box-shadow:var(--shadow-sm)}

  /* ── SECTION HEADERS ── */
  .section-header{display:flex;align-items:center;gap:14px;margin-bottom:20px;margin-top:40px}
  .section-header:first-child{margin-top:0}
  .section-title{
    font-family:'Merriweather',serif;font-size:0.95rem;font-weight:700;
    color:var(--green-dark);white-space:nowrap;letter-spacing:0.01em;
    padding-left:12px;border-left:3px solid var(--gold);
  }
  .section-rule{flex:1;height:1px;background:linear-gradient(to right, var(--border) 0%, transparent 100%)}
  .section-tag{
    font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.12em;
    color:var(--text-light);background:var(--light-gray);padding:4px 12px;
    border-radius:20px;white-space:nowrap;border:1px solid var(--border);
  }

  /* ── CARDS ── */
  .cards-row{display:grid;grid-template-columns:repeat(auto-fill,minmax(200px,1fr));gap:16px;margin-bottom:10px}
  .card{
    background:#fff;border:1px solid var(--border);border-radius:var(--radius);
    padding:20px 22px 18px;position:relative;
    box-shadow:var(--shadow-sm);
    transition:box-shadow 0.2s ease,transform 0.2s ease;
    overflow:hidden;
  }
  .card::before{
    content:'';position:absolute;bottom:-30px;right:-20px;
    width:90px;height:90px;border-radius:50%;
    background:radial-gradient(circle, rgba(45,106,79,0.04) 0%, transparent 70%);
    pointer-events:none;
  }
  .card:hover{box-shadow:var(--shadow-lg);transform:translateY(-2px)}
  .card-accent{position:absolute;top:0;left:0;right:0;height:3px;border-radius:var(--radius) var(--radius) 0 0;background:var(--mid-gray)}
  .card.bench .card-accent{background:linear-gradient(90deg, var(--green-mid), #52b788)}
  .card.positive .card-accent{background:linear-gradient(90deg, var(--pos), #2a9d5c)}
  .card.negative .card-accent{background:linear-gradient(90deg, var(--neg), #e05252)}
  .card-label{font-size:0.7rem;font-weight:700;text-transform:uppercase;letter-spacing:0.1em;color:var(--text-light);margin-bottom:10px}
  .card-value{font-family:'Merriweather',serif;font-size:1.8rem;font-weight:700;line-height:1}
  .card-value.pos{color:var(--pos)}.card-value.neg{color:var(--neg)}.card-value.neu{color:var(--text-dark)}
  .card-type{font-size:0.72rem;color:var(--text-light);margin-top:6px;letter-spacing:0.01em}
  .card-divider{height:1px;background:var(--light-gray);margin:14px 0 10px}
  .card-row{display:flex;justify-content:space-between;font-size:0.82rem;color:var(--text-light);margin-top:7px;align-items:center}
  .card-row .val{font-weight:700;font-size:0.86rem}
  .card-row .val.pos{color:var(--pos)}.card-row .val.neg{color:var(--neg)}.card-row .val.neu{color:var(--text-dark)}

  /* ── CHART CARDS ── */
  .chart-card{
    background:#fff;border:1px solid var(--border);border-radius:var(--radius);
    padding:28px 28px 22px;box-shadow:var(--shadow-sm);
  }
  .chart-card canvas{max-height:270px}

  /* ── HOLDINGS PANEL ── */
  .panel{
    background:#fff;border:1px solid var(--border);border-radius:var(--radius);
    overflow:hidden;box-shadow:var(--shadow-sm);
  }
  .panel-header{
    background:linear-gradient(135deg, #152d22 0%, var(--green-dark) 100%);
    padding:16px 22px;display:flex;justify-content:space-between;align-items:center;
    gap:12px;border-bottom:2px solid var(--gold);
  }
  .panel-title{font-family:'Merriweather',serif;font-size:0.95rem;font-weight:400;color:#fff;letter-spacing:0.01em}
  .panel-return{font-weight:700;padding:4px 12px;border-radius:5px;font-size:0.86rem;letter-spacing:0.02em}
  .panel-return.pos{background:rgba(26,107,60,0.35);color:#90dfb0;border:1px solid rgba(82,214,138,0.2)}
  .panel-return.neg{background:rgba(184,50,50,0.3);color:#f5a0a0;border:1px solid rgba(224,100,100,0.2)}
  .panel-return.neu{background:rgba(255,255,255,0.1);color:rgba(255,255,255,0.6)}
  .panel-bench{font-size:0.76rem;color:rgba(255,255,255,0.45)}
  .panel-bench .pos{color:#90dfb0;font-weight:700}.panel-bench .neg{color:#f5a0a0;font-weight:700}

  /* ── TABLE ── */
  table{width:100%;border-collapse:collapse}
  thead{background:var(--green-xlight)}
  th{
    font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.11em;
    color:var(--green-dark);padding:12px 20px;text-align:right;
    border-bottom:2px solid var(--border);
  }
  th:first-child{text-align:left}
  td{font-size:0.88rem;padding:12px 20px;text-align:right;border-bottom:1px solid var(--light-gray);color:var(--text-mid);transition:background 0.12s}
  td:first-child{text-align:left;color:var(--text-dark);font-weight:600}
  tr:last-child td{border-bottom:none}
  tr:hover td{background:var(--green-xlight)}
  td.pos{color:var(--pos);font-weight:700}td.neg{color:var(--neg);font-weight:700}
  .total-row td{background:var(--green-light)!important;font-weight:700;border-top:2px solid var(--border);border-bottom:none!important;color:var(--green-dark)}
  .total-row td.pos{color:var(--pos)}.total-row td.neg{color:var(--neg)}

  /* ── TICKER TAG ── */
  .ticker-tag{
    display:inline-block;background:var(--green-dark);color:#fff;
    font-size:0.7rem;font-weight:700;letter-spacing:0.07em;
    padding:2px 8px;border-radius:4px;
    box-shadow:0 1px 3px rgba(27,67,50,0.2);
  }

  /* ── HOLDINGS SELECT ── */
  .holdings-selector-row{display:flex;align-items:center;gap:14px;margin-bottom:22px;flex-wrap:wrap}
  .holdings-select{
    font-family:'Source Sans 3',sans-serif;font-size:0.9rem;font-weight:600;
    color:var(--text-dark);background:#fff;border:1.5px solid var(--border);
    border-radius:6px;padding:10px 36px 10px 16px;cursor:pointer;
    appearance:none;-webkit-appearance:none;
    background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath d='M1 1l5 5 5-5' stroke='%237a917e' stroke-width='1.8' fill='none' stroke-linecap='round'/%3E%3C/svg%3E");
    background-repeat:no-repeat;background-position:right 14px center;
    min-width:230px;transition:border-color 0.18s,box-shadow 0.18s;
    box-shadow:var(--shadow-sm);
  }
  .holdings-select:hover{border-color:var(--green-mid)}
  .holdings-select:focus{outline:none;border-color:var(--green);box-shadow:0 0 0 3px rgba(45,106,79,0.1)}
  .holdings-panel-wrap{animation:fadeUp 0.25s ease}

  /* ── FOOTER ── */
  .site-footer{
    background:linear-gradient(135deg, #152d22 0%, var(--green-dark) 100%);
    border-top:2px solid var(--gold);padding:28px 48px;
    text-align:center;font-size:0.73rem;color:rgba(255,255,255,0.3);
    line-height:2;margin-top:70px;
    box-shadow:0 -2px 12px rgba(0,0,0,0.12);
  }
  .site-footer::before{
    content:'';display:block;width:60px;height:1px;
    background:linear-gradient(90deg, transparent, var(--gold), transparent);
    margin:0 auto 16px;opacity:0.4;
  }
</style>
</head>
<body>
<div class="site-header">
  <div class="logo-area">
    <img src="https://nelsoncorp.com/wp-content/uploads/2025/06/NelsonCorp-Logo-2025.png" alt="NelsonCorp" class="logo-img" onerror="this.style.display='none';document.querySelector('.logo-fallback').style.display='block'">
    <div class="logo-fallback" style="display:none;font-family:'Merriweather',serif;color:#fff;font-size:1.1rem;font-weight:700">NelsonCorp Wealth Management</div>
    <div class="logo-divider"></div>
    <div class="logo-sub">Portfolio Analytics</div>
  </div>
  <div class="header-date" id="header-date"></div>
</div>
<div class="title-bar">
  <h1>Daily Portfolio <span>Performance Dashboard</span></h1>
  <div class="title-meta">
    <div class="status-badge"><span class="sdot loading" id="sdot"></span><span id="stext">Connecting...</span></div>
    <div class="update-info" id="update-info"></div>
  </div>
</div>
<div class="main">
  <div id="price-loading-banner" style="background:linear-gradient(135deg,var(--green-xlight),#fff);border:1px solid var(--border);border-radius:8px;padding:13px 20px;margin-bottom:24px;display:flex;align-items:center;gap:12px;font-size:0.84rem;color:var(--text-mid);box-shadow:var(--shadow-sm);">
    <div class="spinner" style="width:18px;height:18px;border-width:2px;margin:0;flex-shrink:0;"></div>
    <span id="banner-text">Loading portfolio data...</span>
  </div>
  <div id="dashboard">
    <div class="dash-controls">
      <div class="dash-controls-left">
        <button class="btn-outline" onclick="fetchAllPrices()">&#8635; Refresh Prices</button>
        <label class="btn-outline" style="font-size:0.8rem;padding:8px 14px;cursor:pointer;">
          &#128194; Upload Updated Spreadsheet
          <input type="file" id="file-input" accept=".xlsx,.xls" style="display:none">
        </label>
        <button class="btn-outline" style="font-size:0.8rem;padding:8px 14px;color:var(--neg);border-color:var(--neg);opacity:0.7;" onclick="resetYTD()" title="Clears saved YTD values — revert to empty state until a new spreadsheet is uploaded">&#10006; Reset YTD</button>
      </div>
      <div class="dash-source" id="dash-source"></div>
    </div>
    <div class="section-header"><div class="section-title">Market Benchmarks</div><div class="section-rule"></div><div class="section-tag">Daily &middot; YTD</div></div>
    <div class="cards-row" id="bench-cards"></div>
    <div class="section-header"><div class="section-title">Portfolio Models</div><div class="section-rule"></div><div class="section-tag">Daily &middot; YTD &middot; vs Benchmark</div></div>
    <div class="cards-row" id="model-cards"></div>
    <div class="section-header"><div class="section-title">Performance Comparison</div><div class="section-rule"></div></div>
    <div class="chart-card" style="margin-bottom:16px">
      <div style="font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-light);margin-bottom:16px;display:flex;align-items:center;gap:8px"><span style="display:inline-block;width:3px;height:12px;background:var(--gold);border-radius:2px"></span>Daily Return</div>
      <canvas id="perf-chart-daily"></canvas>
    </div>
    <div class="chart-card" style="margin-bottom:8px">
      <div style="font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.12em;color:var(--text-light);margin-bottom:16px;display:flex;align-items:center;gap:8px"><span style="display:inline-block;width:3px;height:12px;background:var(--gold);border-radius:2px"></span>Year-to-Date Return</div>
      <canvas id="perf-chart-ytd"></canvas>
    </div>
    <div class="section-header"><div class="section-title">Holdings Detail</div><div class="section-rule"></div></div>
    <div class="holdings-selector-row">
      <select class="holdings-select" id="holdings-select" onchange="showSelectedPortfolio()">
        <option value="">&#8212; Select a portfolio &#8212;</option>
      </select>
    </div>
    <div id="holdings-panels"></div>
  </div>
</div>
<div class="site-footer">
  NelsonCorp Wealth Management &nbsp;&middot;&nbsp; Internal Use Only &nbsp;&middot;&nbsp; 880 13th Avenue North, Clinton, Iowa 52732<br>
  Securities offered through Registered Representatives of Cambridge Investment Research, Inc., a broker-dealer, member FINRA/SIPC.
  Advisory services through Cambridge Investment Research Advisors, Inc., a Registered Investment Advisor.
</div>
<script>
// =================================================================
// NELSONCORP DASHBOARD - fully spreadsheet-driven
//
// HOW TO MAKE CHANGES (no code edits needed):
//   Add/remove benchmarks  -> edit "Benchmarks" sheet, upload .xlsx to GitHub repo
//   Add/remove/edit models -> edit "NelsonCorp" sheet, upload .xlsx to GitHub repo
//   Update YTD figures     -> click "Upload Updated Spreadsheet" on the page
//
// SPREADSHEET STRUCTURE (keep sheet names exactly as shown):
//
// "Benchmarks" sheet - repeating block per benchmark:
//   Row: Display name      e.g. "S&P 500"
//   Row: Header            Ticker / Weight / Return / Total Return
//   Row: Data              SPYM / 1 / [formula] / [formula]
//   Row: Total             blank / [SUM] / blank / [SUM]
//   Row: blank separator
//   ...next benchmark...
//
// "NelsonCorp" sheet - repeating block per model:
//   Row: Model name        e.g. "MODERATE"
//   Row: Header            Ticker / Weight / Return / Total Return / +/- Benchmark
//   Rows: Holdings         TICKER / weight / [formula] / [formula] / blank
//   Row: Total             blank / [SUM] / blank / [SUM] / [bench diff]
//   Row: blank separator
//   ...next model...
//
// "Dashboard" sheet - YTD values read on manual upload:
//   Row 1: Headers (Model / blank / Daily / +/-Bench / YTD / ...)
//   Benchmark rows: col A=name, col D=blank, col E=YTD decimal
//   Model rows:     col A=name, col D=value, col E=YTD decimal
//   Benchmark rows must appear BEFORE model rows.
//   ORDER of benchmarks in Dashboard must match order in Benchmarks sheet.
//
// The FIRST benchmark in the Benchmarks sheet is the primary comparison
// index used for all "vs Benchmark" calculations.
// =================================================================

const FINNHUB_KEY = 'd6b2sl9r01qnr27jfc2gd6b2sl9r01qnr27jfc30';
const REFRESH_MS  = 60 * 1000;

// Repo settings (used to pull the latest spreadsheet without editing code)
/**
 * Repo defaults (fallback).
 * If hosted on GitHub Pages (https://<owner>.github.io/<repo>/...), we auto-detect owner/repo from the URL.
 */
const DEFAULT_GITHUB_OWNER  = 'nelsoncorp';
const DEFAULT_GITHUB_REPO   = 'portfolio-dashboard';
const DEFAULT_GITHUB_BRANCH = 'main';

function detectGithubPagesRepo() {
  try {
    const host = window.location.hostname || '';
    const path = window.location.pathname || '/';
    // GitHub Pages pattern: <owner>.github.io / <repo> / ...
    if (!host.endsWith('github.io')) return null;
    const owner = host.split('.')[0];
    const parts = path.split('/').filter(Boolean);
    const repo = parts.length ? parts[0] : null;
    if (!owner || !repo) return null;
    return { owner, repo, branch: DEFAULT_GITHUB_BRANCH };
  } catch (e) {
    return null;
  }
}

const __det = detectGithubPagesRepo();
const GITHUB_OWNER  = (__det && __det.owner)  ? __det.owner  : DEFAULT_GITHUB_OWNER;
const GITHUB_REPO   = (__det && __det.repo)   ? __det.repo   : DEFAULT_GITHUB_REPO;
const GITHUB_BRANCH = (__det && __det.branch) ? __det.branch : DEFAULT_GITHUB_BRANCH;

// If you rename the Excel file in the repo, add the new name here (URL-encoded).
// The dashboard will use the first one it can successfully load.
const EXCEL_CANDIDATES = [
  'Eck%20Daily%20Portfolio%20Performance.xlsx',
  'NCorp%20Daily%20Portfolio%20Performance.xlsx',
  'NCorp%20Daily%20Portfolio%20Performance.xls',
  'Eck%20Daily%20Portfolio%20Performance.xls'
];

function githubRawUrl(fileEncoded) {
  return 'https://raw.githubusercontent.com/' + GITHUB_OWNER + '/' + GITHUB_REPO + '/' + GITHUB_BRANCH + '/' + fileEncoded;
}

// State
// BENCHMARKS[i] = { name (display), ticker (Finnhub), dashName (Dashboard col A) }
let BENCHMARKS = [];
let etfPrices  = {};   // ticker -> { daily }
let benchYTD   = {};   // dashName -> YTD decimal (from spreadsheet)
let modelYTD   = {};   // model name -> YTD decimal (from spreadsheet)
let modelYTDNorm = {}; // normalized model name -> YTD decimal (case-insensitive)
let ytdAsOfDate = null; // "YYYY-MM-DD" — the "as of" date stamped in the spreadsheet
let models     = [];   // [{ name, holdings: [{ ticker, weight }] }]
let chartInst  = null;
let priceTimer = null;

function primaryTicker()   { return BENCHMARKS.length ? BENCHMARKS[0].ticker   : null; }
function primaryDashName() { return BENCHMARKS.length ? BENCHMARKS[0].dashName : null; }
function primaryName()     { return BENCHMARKS.length ? BENCHMARKS[0].name     : 'Benchmark'; }

// Init
document.getElementById('header-date').textContent = new Date().toLocaleDateString('en-US',{
  weekday:'long',year:'numeric',month:'long',day:'numeric'
});
try {
  const saved = localStorage.getItem('ncorp_ytd');
  if (saved) { const p=JSON.parse(saved); benchYTD=p.benchYTD||{}; modelYTD=p.modelYTD||{}; modelYTDNorm=p.modelYTDNorm||{}; ytdAsOfDate=p.ytdAsOfDate||null; }
} catch(e){}

// Returns "YYYY-MM-DD" for the most recent completed trading day.
// On weekdays before the open (before 9:30am ET), that's yesterday.
// On weekends, that's the prior Friday.
function getRecentTradingDayKey() {
  const now = new Date();
  const etStr = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
  const et = new Date(etStr);
  const d = new Date(et);
  const totalMins = d.getHours() * 60 + d.getMinutes();
  if (d.getDay() !== 0 && d.getDay() !== 6 && totalMins < 570) d.setDate(d.getDate() - 1);
  while (d.getDay() === 0 || d.getDay() === 6) d.setDate(d.getDate() - 1);
  return d.getFullYear() + '-' +
    String(d.getMonth() + 1).padStart(2,'0') + '-' +
    String(d.getDate()).padStart(2,'0');
}

// Returns true if dateStr ("YYYY-MM-DD") is the most recent trading day.
function isRecentTradingDay(dateStr) {
  return dateStr === getRecentTradingDayKey();
}

window.addEventListener('DOMContentLoaded', async () => {
  document.getElementById('dashboard').style.display = 'block';
  setBanner('Loading portfolio data from GitHub...');
  await loadGithubExcel();
  fetchAllPrices();
});

// Load from GitHub (weights + structure only, no YTD)
async function loadGithubExcel() {
  // Try a short list of expected filenames so spreadsheet swaps don't require HTML edits.
  for (const f of EXCEL_CANDIDATES) {
    const url = githubRawUrl(f) + '?t=' + Date.now();
    try {
      const res = await fetch(url);
      if (!res.ok) continue;
      parseExcel(await res.arrayBuffer(), f.replace(/%20/g,' '), true);
      console.log('GitHub Excel loaded OK:', f);
      return;
    } catch(e) {
      // try next candidate
    }
  }
  console.warn('Could not load any GitHub Excel candidates');
  setBanner('Could not reach the spreadsheet in GitHub. Upload the spreadsheet manually to populate the dashboard.');
  setTimeout(hideBanner, 6000);
}

 // Manual upload (weights + structure + YTD)
document.getElementById('file-input').addEventListener('change', e => {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = ev => parseExcel(ev.target.result, file.name, true);
  reader.readAsArrayBuffer(file);
  e.target.value = '';
});

// Master parse function
function parseExcel(buffer, source, updateYTD) {
  const wb = XLSX.read(buffer, { type:'array', cellDates: true });
  const sheets = {};
  wb.SheetNames.forEach(n => {
    sheets[n] = XLSX.utils.sheet_to_json(wb.Sheets[n], { header:1, defval:null, raw:true });
  });

  // 1. Benchmarks sheet -> [{ name, ticker }] in order
  const benchFromSheet = parseBenchmarksSheet(sheets['Benchmarks'] || []);

  // 2. Dashboard sheet -> benchmark dashNames + YTD (in order), model YTD map, as-of date
  const { benchDashRows, modelYTDMap, modelYTDMapNorm, asOfDate } = parseDashboardSheet(sheets['Dashboard'] || []);

  // 3. Zip by position - handles name mismatches (e.g. "Dow Jones Industrial Average" vs "Dow")
  BENCHMARKS = benchFromSheet.map((b, i) => ({
    name:     b.name,
    ticker:   b.ticker,
    dashName: benchDashRows[i] ? benchDashRows[i].dashName : b.name,
  }));

  // 4. Portfolio sheets -> models (auto-detect)
  const parsedModels = parseAllPortfolioSheets(sheets);
  if (parsedModels.length) models = parsedModels;

  // 5. Persist YTD on manual upload
  if (updateYTD) {
    const newBenchYTD = {};
    benchDashRows.forEach(r => { newBenchYTD[r.dashName] = r.ytd; });
    benchYTD = newBenchYTD;
    modelYTD = modelYTDMap;
    modelYTDNorm = modelYTDMapNorm;
    ytdAsOfDate = asOfDate || null;
    try { localStorage.setItem('ncorp_ytd', JSON.stringify({ benchYTD, modelYTD, modelYTDNorm, ytdAsOfDate })); } catch(e){}
    document.getElementById('update-info').textContent =
      'YTD updated ' + new Date().toLocaleTimeString('en-US',{timeStyle:'short'}) +
      (ytdAsOfDate ? '  ·  As of ' + ytdAsOfDate : '  ·  ⚠ No "YTD As Of" date found in spreadsheet');
  }

  document.getElementById('dash-source').textContent = updateYTD
    ? 'Prices auto-refresh every minute  ·  YTD loaded from: ' + source
    : 'Prices auto-refresh every minute  ·  YTD: ' +
      ((Object.keys(modelYTD).length || Object.keys(modelYTDNorm).length)
        ? (ytdAsOfDate ? 'as of ' + ytdAsOfDate : 'loaded (no as-of date — upload spreadsheet with "YTD As Of" date)')
        : 'upload spreadsheet to populate YTD');

  console.log('Benchmarks:', BENCHMARKS.map(b => b.name + ' (' + b.ticker + ') -> "' + b.dashName + '"'));
  console.log('Models:', models.map(m => m.name + ' (' + m.holdings.length + ' holdings)'));
  renderAll();
}

// Parse "Benchmarks" sheet
// Pattern: name row (col A=text, col B=null) -> header (col A="Ticker") ->
//          data row (col A=ticker, col B=1) -> total row (col A=null) -> blank
function parseBenchmarksSheet(rows) {
  const result = [];
  let pendingName = null;
  for (const r of rows) {
    const colA = String(r[0] || '').trim();
    const colB = r[1];
    if (colA === 'Ticker') continue;
    if (colA && (colB === null || colB === '')) { pendingName = colA; continue; }
    if (colA && pendingName && !isNaN(parseFloat(colB))) {
      result.push({ name: pendingName, ticker: colA.toUpperCase() });
      pendingName = null;
    }
    if (!colA) pendingName = null;
  }
  return result;
}

// Convert an Excel cell value to a "YYYY-MM-DD" string.
// Handles JS Date objects (from cellDates:true), plain strings, and raw serial numbers.
function parseDateValue(val) {
  if (!val) return null;
  let d;
  if (val instanceof Date) {
    d = val;
  } else if (typeof val === 'number') {
    // Excel serial date (days since 1900-01-01, with Lotus bug offset)
    d = new Date((val - 25569) * 86400 * 1000);
  } else if (typeof val === 'string') {
    d = new Date(val);
  } else {
    return null;
  }
  if (isNaN(d)) return null;
  return d.getFullYear() + '-' +
    String(d.getMonth() + 1).padStart(2,'0') + '-' +
    String(d.getDate()).padStart(2,'0');
}

// Parse "Dashboard" sheet
// Row 0 (optional): "YTD As Of" | <date>  ← new "as of" date row
// Benchmark rows: col D (idx 3) = null -> { dashName, ytd }
// Model rows:     col D (idx 3) = value -> modelYTDMap[name] = ytd
function normName(s) {
  return String(s || '')
    .trim()
    .toLowerCase()
    .replace(/\s+/g, ' ');
}

// Parse "Dashboard" sheet
// Row 0 (optional): "YTD As Of" | <date>  ← new "as of" date row
// Benchmark rows: col D (idx 3) = null -> { dashName, ytd }
// Model rows:     col D (idx 3) = value -> modelYTDMap[name] = ytd
function parseDashboardSheet(rows) {
  const benchDashRows   = [];
  const modelYTDMap     = {};
  const modelYTDMapNorm = {};
  let asOfDate          = null;

  // Try to read the "YTD As Of" date from the very first row
  if (rows.length > 0) {
    const label = String(rows[0][0] || '').trim().toLowerCase();
    if (label === 'ytd as of') {
      asOfDate = parseDateValue(rows[0][1]);
    }
  }

  for (let i = 1; i < rows.length; i++) {
    const r    = rows[i];
    const name = String(r[0] || '').trim();
    if (!name || name === 'Model') continue;

    const ytd       = parseFloat(r[4]);
    const benchDiff = r[3];
    if (isNaN(ytd)) continue;

    if (benchDiff === null || benchDiff === '') {
      benchDashRows.push({ dashName: name, ytd });
    } else {
      modelYTDMap[name] = ytd;
      modelYTDMapNorm[normName(name)] = ytd;
    }
  }
  return { benchDashRows, modelYTDMap, modelYTDMapNorm, asOfDate };
}

// Parse portfolio sheets
// Any sheet name other than "Benchmarks" and "Dashboard" is treated as a portfolio group.
// Each sheet can contain one or more repeating model blocks:
//
//   Row: Model name
//   Row: Header (starts with "Ticker")
//   Rows: Holdings (Ticker / Weight / ...)
//   Row: Total (blank ticker)
//   Row(s): blank separator
//
// This allows you to add/remove portfolios in Excel without touching the HTML.
function parseAllPortfolioSheets(allSheets) {
  const ignore = new Set(['Benchmarks', 'Dashboard']);
  const sheetNames = Object.keys(allSheets || {}).filter(n => !ignore.has(n));
  let allModels = [];
  sheetNames.forEach(sn => {
    const rows = allSheets[sn] || [];
    allModels = allModels.concat(parsePortfolioSheet(rows, sn));
  });

  // De-dupe by normalized name, keeping first
  const seen = new Set();
  const deduped = [];
  allModels.forEach(m => {
    const k = normName(m.name);
    if (seen.has(k)) return;
    seen.add(k);
    deduped.push(m);
  });
  return deduped;
}

// More robust than the prior parser:
// - Finds each block by locating a header row where col A == "Ticker"
// - Uses the closest non-empty row above it as the model name
function parsePortfolioSheet(rows, sheetName) {
  const result = [];
  const isHeader = r => String((r && r[0]) || '').trim().toLowerCase() === 'ticker';

  for (let i = 0; i < rows.length; i++) {
    const r = rows[i];
    if (!isHeader(r)) continue;

    // Find model name above header
    let name = null;
    for (let j = i - 1; j >= 0; j--) {
      const a = String((rows[j] && rows[j][0]) || '').trim();
      if (a) { name = a; break; }
    }
    if (!name) continue;

    // Read holdings until blank ticker
    const holdings = [];
    for (let k = i + 1; k < rows.length; k++) {
      const row = rows[k] || [];
      const ticker = String(row[0] || '').trim();
      if (!ticker) break;
      const w = parseFloat(row[1]);
      if (!isNaN(w) && w > 0) holdings.push({ ticker: ticker.toUpperCase(), weight: w });
    }

    if (holdings.length) {
      result.push({ name: toTitleCase(name), holdings, group: sheetName });
    }
  }
  return result;
}

function toTitleCase(str) {
  return str.replace(/\w\S*/g, w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase());
}

// Fetch live prices from Finnhub
function allTickers() {
  const s = new Set();
  BENCHMARKS.forEach(b => s.add(b.ticker));
  models.forEach(m => m.holdings.forEach(h => { if (h.ticker !== 'CASH') s.add(h.ticker); }));
  return [...s];
}

async function fetchAllPrices() {
  setBanner('Fetching live prices...');
  setStatus('loading', 'Fetching prices...');
  const tickers = allTickers();
  const newPrices = {};
  let fetched = 0;
  for (const ticker of tickers) {
    try {
      const res = await fetch('https://finnhub.io/api/v1/quote?symbol=' + ticker + '&token=' + FINNHUB_KEY);
      if (!res.ok) continue;
      const q = await res.json();
      if (!q || !q.c || !q.pc) continue;
      newPrices[ticker] = { daily: (q.c - q.pc) / q.pc };
      fetched++;
    } catch(e) { console.warn('Finnhub failed for', ticker, e); }
  }
  hideBanner();
  if (fetched === 0) {
    setStatus('error', 'Price fetch failed');
    document.getElementById('update-info').textContent = 'Could not reach Finnhub - check connection';
    return;
  }
  etfPrices = newPrices;
  if (isMarketOpen()) {
    setStatus('live', 'Live - Finnhub (' + fetched + '/' + tickers.length + ' tickers)');
    document.getElementById('update-info').textContent =
      'Prices updated ' + new Date().toLocaleTimeString('en-US',{timeStyle:'short'});
  } else if (isTradingDayAfterOpen()) {
    setStatus('loading', "Market Closed — YTD reflects today's close");
    document.getElementById('update-info').textContent =
      "Market closed · YTD updated through today's close · " +
      new Date().toLocaleTimeString('en-US',{timeStyle:'short'});
  } else {
    setStatus('loading', 'Market Closed — YTD as of prior close');
    document.getElementById('update-info').textContent =
      'Pre-market · YTD reflects prior trading day\'s close';
  }
  renderAll();
  clearInterval(priceTimer);
  priceTimer = setInterval(fetchAllPrices, REFRESH_MS);
}

// Returns true if the US equity market is currently open (Mon–Fri, 9:30–16:00 ET)
function isMarketOpen() {
  const now = new Date();
  const etStr = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
  const et = new Date(etStr);
  const day = et.getDay(); // 0=Sun, 6=Sat
  if (day === 0 || day === 6) return false;
  const totalMins = et.getHours() * 60 + et.getMinutes();
  return totalMins >= 570 && totalMins < 960; // 9:30am=570, 4:00pm=960
}

// Returns true on weekdays from market open (9:30am) through end of day.
// This means after the close we still compound today's daily return, because
// Finnhub's prices after 4pm ET reflect today's actual closing prices — the
// YTD base from the spreadsheet is still yesterday's close until the user
// re-uploads the next morning.
function isTradingDayAfterOpen() {
  const now = new Date();
  const etStr = now.toLocaleString('en-US', { timeZone: 'America/New_York' });
  const et = new Date(etStr);
  const day = et.getDay();
  if (day === 0 || day === 6) return false;
  const totalMins = et.getHours() * 60 + et.getMinutes();
  return totalMins >= 570; // 9:30am onwards — covers market hours AND post-close
}

function calcModelDaily(model) {
  let total = 0;
  for (const h of model.holdings) {
    if (h.ticker === 'CASH') continue;
    const p = etfPrices[h.ticker];
    if (p) total += h.weight * p.daily;
  }
  return total;
}

function getEffectiveBenchYTD(dashName) { return benchYTD[dashName] ?? null; }
function getEffectiveModelYTD(name)     { return getModelYTD(name); }

// Determine the correct YTD value to display.
//
// The spreadsheet's "YTD As Of" date tells us whether the base already
// includes the most recent trading day's return:
//
//   ytdAsOfDate == most recent trading day
//     → base is current. Only layer in live movement if market is open now.
//
//   ytdAsOfDate is behind (or missing)
//     → base is stale. Always compound Finnhub's daily on top.
//       • During market hours: adds today's live movement.
//       • After close / weekend / pre-market: Finnhub returns the most
//         recent closing prices, so this automatically catches up.
//
function realtimeYTD(ytdBase, daily) {
  if (ytdBase == null) return null;
  if (daily == null)   return ytdBase;
  if (ytdAsOfDate && ytdAsOfDate >= getRecentTradingDayKey()) {
    // Spreadsheet is already current — only add live movement during market hours
    return isMarketOpen() ? (1 + ytdBase) * (1 + daily) - 1 : ytdBase;
  }
  // Spreadsheet is behind — always compound
  return (1 + ytdBase) * (1 + daily) - 1;
}

function getModelYTD(name) {
  if (!name) return null;
  return modelYTD[name] ?? modelYTD[toTitleCase(name)] ?? modelYTDNorm[normName(name)] ?? null;
}

function renderAll() {
  renderBenchCards();
  renderModelCards();
  renderChart();
  renderHoldingsDropdown();
  renderYTDStalenessWarning();
}

// Show a banner if the spreadsheet's as-of date is behind the most recent
// trading day by more than one day — meaning YTD numbers may be incomplete.
function renderYTDStalenessWarning() {
  const bannerId = 'ytd-staleness-banner';
  let banner = document.getElementById(bannerId);
  if (!banner) {
    banner = document.createElement('div');
    banner.id = bannerId;
    banner.style.cssText = 'background:#fff8e1;border:1px solid #f0d080;border-radius:6px;padding:10px 18px;margin-bottom:16px;font-size:0.82rem;color:#7a5c00;display:none;';
    document.getElementById('dashboard').insertBefore(banner, document.querySelector('.dash-controls'));
  }
  if (!ytdAsOfDate) { banner.style.display = 'none'; return; }
  const recent = getRecentTradingDayKey();
  if (ytdAsOfDate >= recent) { banner.style.display = 'none'; return; }
  // Count how many trading days behind
  const asOf = new Date(ytdAsOfDate + 'T00:00:00');
  const recentD = new Date(recent + 'T00:00:00');
  let days = 0, d = new Date(asOf);
  while (d < recentD) {
    d.setDate(d.getDate() + 1);
    if (d.getDay() !== 0 && d.getDay() !== 6) days++;
  }
  if (days <= 1) { banner.style.display = 'none'; return; }
  banner.style.display = 'block';
  banner.textContent = '⚠  YTD data is ' + days + ' trading days behind (as of ' + ytdAsOfDate + '). Upload an updated spreadsheet for accurate YTD figures.';
}

function renderBenchCards() {
  const row = document.getElementById('bench-cards');
  row.innerHTML = '';
  BENCHMARKS.forEach(b => {
    const p = etfPrices[b.ticker];
    const daily = p ? p.daily : null;
    const ytd = realtimeYTD(getEffectiveBenchYTD(b.dashName), daily);
    const noYTD = getEffectiveBenchYTD(b.dashName) == null;
    const div = document.createElement('div');
    div.className = 'card bench ' + (daily > 0 ? 'positive' : daily < 0 ? 'negative' : '');
    div.innerHTML =
      '<div class="card-accent"></div>' +
      '<div class="card-label">' + b.name + '</div>' +
      '<div class="card-value ' + cc(daily) + '">' + fmt(daily) + '</div>' +
      '<div class="card-type">Daily Return - ' + b.ticker + '</div>' +
      '<div class="card-divider"></div>' +
      '<div class="card-row"><span>YTD</span><span class="val ' + cc(ytd) + '">' +
        (noYTD ? '<span style="color:var(--text-light);font-weight:400;font-size:0.78rem">Upload Spreadsheet</span>' : fmt(ytd)) +
      '</span></div>';
    row.appendChild(div);
  });
}

function renderModelCards() {
  const row = document.getElementById('model-cards');
  row.innerHTML = '';
  const pt = primaryTicker();
  const pd = primaryDashName();
  const pl = primaryName();
  const primDaily = pt ? (etfPrices[pt] ? etfPrices[pt].daily : null) : null;
  const primYTD   = realtimeYTD(getEffectiveBenchYTD(pd), primDaily);
  models.forEach(m => {
    const daily      = calcModelDaily(m);
    const dailyBench = primDaily != null ? daily - primDaily : null;
    const ytdBase    = getEffectiveModelYTD(m.name);
    const ytd        = realtimeYTD(ytdBase, daily);
    const ytdBench   = (ytd != null && primYTD != null) ? ytd - primYTD : null;
    const noYTD      = ytdBase == null;
    const div = document.createElement('div');
    div.className = 'card ' + (daily > 0 ? 'positive' : daily < 0 ? 'negative' : '');
    div.innerHTML =
      '<div class="card-accent"></div>' +
      '<div class="card-label">' + m.name + '</div>' +
      '<div class="card-value ' + cc(daily) + '">' + fmt(daily) + '</div>' +
      '<div class="card-type">' + (isMarketOpen() ? 'Daily Return (Live)' : isTradingDayAfterOpen() ? 'Daily Return (Today\'s Close)' : 'Daily Return (Prior Close)') + '</div>' +
      '<div class="card-divider"></div>' +
      '<div class="card-row"><span>vs ' + pl + '</span><span class="val ' + cc(dailyBench) + '">' + fmt(dailyBench) + '</span></div>' +
      '<div class="card-row"><span>YTD</span><span class="val ' + cc(ytd) + '">' +
        (noYTD ? '<span style="color:var(--text-light);font-weight:400;font-size:0.78rem">Upload Spreadsheet</span>' : fmt(ytd)) +
      '</span></div>' +
      (ytdBench != null ? '<div class="card-row"><span>YTD vs ' + pl + '</span><span class="val ' + cc(ytdBench) + '">' + fmt(ytdBench) + '</span></div>' : '');
    row.appendChild(div);
  });
}

let chartDaily = null, chartYTD = null;

function renderChart() {
  // Build data for both charts
  const all = [
    ...BENCHMARKS.map(b => ({
      label: b.name,
      daily: etfPrices[b.ticker] ? etfPrices[b.ticker].daily : 0,
      ytd: realtimeYTD(getEffectiveBenchYTD(b.dashName), etfPrices[b.ticker] ? etfPrices[b.ticker].daily : null),
      isBench: true
    })),
    ...models.map(m => {
      const d = calcModelDaily(m);
      return { label: m.name, daily: d, ytd: realtimeYTD(getEffectiveModelYTD(m.name), d), isBench: false };
    })
  ];

  const labels = all.map(d => d.label);
  const sharedOptions = {
    responsive: true,
    plugins: {
      legend: { display: false },
      tooltip: {
        backgroundColor: '#1b4332', borderColor: '#c9a84c', borderWidth: 1,
        titleColor: '#fff', titleFont: { family: 'Source Sans 3', size: 13 },
        bodyColor: '#d8f3dc', bodyFont: { family: 'Source Sans 3', size: 13 }, padding: 12,
        callbacks: {
          label: c => c.parsed.y == null
            ? ' -'
            : ' ' + (c.parsed.y > 0 ? '+' : '') + c.parsed.y.toFixed(2) + '%'
        }
      }
    },
    scales: {
      x: { ticks: { color: '#7a917e', font: { family: 'Source Sans 3', size: 12 } }, grid: { color: '#eef0eb' } },
      y: { ticks: { color: '#7a917e', font: { family: 'Source Sans 3', size: 12 }, callback: v => v.toFixed(2) + '%' }, grid: { color: '#eef0eb' } }
    }
  };

  // ── DAILY CHART ──
  if (chartDaily) { chartDaily.destroy(); chartDaily = null; }
  chartDaily = new Chart(document.getElementById('perf-chart-daily'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data: all.map(d => +(d.daily * 100).toFixed(3)),
        backgroundColor: all.map(d => d.isBench
          ? (d.daily >= 0 ? 'rgba(64,145,108,0.8)' : 'rgba(184,50,50,0.65)')
          : (d.daily >= 0 ? 'rgba(27,67,50,0.9)'   : 'rgba(184,50,50,0.65)')),
        borderRadius: 4, barPercentage: 0.6
      }]
    },
    options: sharedOptions
  });

  // ── YTD CHART ──
  if (chartYTD) { chartYTD.destroy(); chartYTD = null; }
  // Separate colors: benchmarks in green-mid, models in green-dark; grey if no YTD data
  chartYTD = new Chart(document.getElementById('perf-chart-ytd'), {
    type: 'bar',
    data: {
      labels,
      datasets: [{
        data: all.map(d => d.ytd != null ? +(d.ytd * 100).toFixed(2) : null),
        backgroundColor: all.map(d => {
          if (d.ytd == null) return 'rgba(196,203,191,0.5)';
          return d.isBench
            ? (d.ytd >= 0 ? 'rgba(64,145,108,0.8)' : 'rgba(184,50,50,0.65)')
            : (d.ytd >= 0 ? 'rgba(201,168,76,0.85)' : 'rgba(184,50,50,0.65)');
        }),
        borderRadius: 4, barPercentage: 0.6
      }]
    },
    options: {
      ...sharedOptions,
      plugins: {
        ...sharedOptions.plugins,
        tooltip: {
          ...sharedOptions.plugins.tooltip,
          callbacks: {
            label: c => c.parsed.y == null
              ? ' No YTD data - upload spreadsheet'
              : ' ' + (c.parsed.y > 0 ? '+' : '') + c.parsed.y.toFixed(2) + '%'
          }
        }
      }
    }
  });
}

function renderHoldingsDropdown() {
  const select = document.getElementById('holdings-select');
  const prev = select.value;
  select.innerHTML = '<option value="">- Select a portfolio -</option>';
  models.forEach((m,i) => { const o=document.createElement('option'); o.value=i; o.textContent=m.name; select.appendChild(o); });
  select.value = (prev!==''&&select.querySelector('option[value="'+prev+'"]')) ? prev : '0';
  showSelectedPortfolio();
}

function showSelectedPortfolio() {
  const select=document.getElementById('holdings-select'), container=document.getElementById('holdings-panels');
  const idx=select.value;
  if (idx===''||!models[idx]) { container.innerHTML=''; return; }
  const m=models[idx], pt=primaryTicker(), pl=primaryName();
  const primDaily=pt?(etfPrices[pt]?etfPrices[pt].daily:null):null;
  let liveTotal=0, rows='';
  m.holdings.forEach(h => {
    const liveRet=(h.ticker!=='CASH'&&etfPrices[h.ticker])?etfPrices[h.ticker].daily:0;
    const contrib=h.weight*liveRet; liveTotal+=contrib;
    rows+='<tr><td><span class="ticker-tag">'+h.ticker+'</span></td><td>'+(h.weight*100).toFixed(1)+'%</td><td class="'+cc(liveRet)+'">'+(h.ticker==='CASH'?'-':fmt(liveRet))+'</td><td class="'+cc(contrib)+'">'+(h.ticker==='CASH'?'-':fmt(contrib))+'</td></tr>';
  });
  const liveBench=primDaily!=null?liveTotal-primDaily:null;
  rows+='<tr class="total-row"><td>Portfolio Total</td><td></td><td></td><td class="'+cc(liveTotal)+'">'+fmt(liveTotal)+'</td></tr>';
  const benchStr=liveBench!=null?'<span class="panel-bench" style="margin-left:10px">vs '+pl+' <span class="'+cc(liveBench)+'">'+fmt(liveBench)+'</span></span>':'';
  container.innerHTML='';
  const wrap=document.createElement('div'); wrap.className='holdings-panel-wrap';
  wrap.innerHTML='<div class="panel"><div class="panel-header"><span class="panel-title">'+m.name+'</span><div style="display:flex;align-items:center;gap:10px"><span class="panel-return '+cc(liveTotal)+'">'+fmt(liveTotal)+'</span>'+benchStr+'</div></div><table><thead><tr><th>Ticker</th><th>Weight</th><th>Return</th><th>Contribution</th></tr></thead><tbody>'+rows+'</tbody></table></div>';
  container.appendChild(wrap);
}

function resetYTD() {
  if (!confirm('Clear all saved YTD values? The dashboard will show no YTD data until you upload a new spreadsheet.')) return;
  benchYTD = {}; modelYTD = {}; ytdAsOfDate = null;
  try { localStorage.removeItem('ncorp_ytd'); } catch(e){}
  renderAll();
  document.getElementById('update-info').textContent = 'YTD cleared — upload a spreadsheet to restore';
}
function setStatus(state,text){document.getElementById('sdot').className='sdot '+state;document.getElementById('stext').textContent=text;}
function setBanner(msg){document.getElementById('banner-text').textContent=msg;document.getElementById('price-loading-banner').style.display='flex';}
function hideBanner(){document.getElementById('price-loading-banner').style.display='none';}
function fmt(val,dec=2){if(val==null||isNaN(val))return '-';const p=val*100;return(p>0?'+':'')+p.toFixed(dec)+'%';}
function cc(val){if(val==null||isNaN(val))return 'neu';return val>0?'pos':val<0?'neg':'neu';}
</script>
</body>
</html>